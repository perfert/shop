$(function(){function s(){sendJsonp("/Order/Cart",{},b)}var f=$("#cartList"),l=$("#divPay"),a=$("#divNone"),w=$("#bankList"),i=$("#btnPay"),e,v=function(n,t){if(t=parseInt(t),isNaN(t)||t>999999){$.PageDialog.fail("输入有误.");return}sendJsonp("/Order/SetCart",{termId:n,count:t},function(i){if(i.result==0){if(t==0){location.reload();return}getCartNum(y);var r=$("[data-termid="+n+"]");r.find(".d-count").text(t);r.find(".d-overage").text(i.Overage);r.find(".z-amount").attr("data-value",t).attr("data-overage",i.Overage)}else $.PageDialog.fail(i.desc),s()})},b=function(n){var i,t,r;if(n.result==404){goLogin();return}if(n.data==null||n.data.length==0){f.parent().hide();l.hide();a.show();return}for(f.parent().show(),l.show(),a.hide(),i=_.template($("#tpItem").html()),f.empty(),t=0;t<n.data.length;t++)r=i(n.data[t]),f.append(r);y()},p;$(document).on("click",".z-del",function(){var n=$(this).attr("data-termid");return $.PageDialog.confirm("您确定要删除吗？",function(){v(n,0)}),!1});$(document).on("click",".z-jian",function(){var i=$(this),n=i.siblings(".z-amount"),t=n.val();if(!(t<=1))return t--,n.val(t),n.trigger("input"),!1});$(document).on("click",".z-jia",function(){var i=$(this),n=i.siblings(".z-amount"),t=n.val();return t++,n.val(t),n.trigger("input"),!1});$(document).on("input",".z-amount",function(){var n=$(this),r=$(this).parent().attr("data-termid"),i=n.attr("data-value"),t=n.val(),u=n.attr("data-overage");if(i!=t&&t!="")if(/^[1-9]{1}\d{0,6}$/.test(t)){if(parseInt(u)<parseInt(t)){$.PageDialog.fail("库存不足了.");n.val(i);return}$.attr("data-value",t);v(r,t)}else $.PageDialog.fail("输入有误"),n.val(i),n.focus()});var n=$("#spBalance"),o=0,r=0,h=function(t){var r=parseFloat($("[data-userinfo='cartamount']").html()),u=parseFloat($("[data-userinfo='balance']").html()),i=r>u?u:r;t>0?(n.parent().removeClass("z-pay-grayC"),n.attr("sel","1").attr("class","z-pay-mentsel")):(i=0,n.attr("sel","0").attr("class","z-pay-ment"));$("#oamount").html(i.toFixed(2));o=i;k(r-i)},u=!1,t="",k=function(n){n>0?(r=n,e.removeClass("z-pay-grayC").html('<s class="z-arrow"><\/s>选择<b class="z-mlr">'+t+"<\/b>支付"+(o>0?"剩余":"")+'<em class="orange">'+r.toFixed(2)+"<\/em>元").nextAll().show(),u=!0):(r=0,e.addClass("z-pay-grayC").html('<s class="z-arrow"><\/s>选择网银支付').nextAll().hide(),u=!1)};$("li",w).each(function(n){var i=$(this);if(n==0){e=i;i.click(function(){i.hasClass("z-pay-grayC")||(u?(i.nextAll().show(),u=!1):(i.nextAll().show(),u=!0))});return}t==""&&(t=i.text());i.click(function(){t=i.text();i.children("i").attr("class","z-bank-Roundsel");i.siblings().each(function(){$(this).children("i").attr("class","z-bank-Round")});e.html('<s class="z-arrow"><\/s>选择<b class="z-mlr">'+t+"<\/b>支付"+(o>0?"剩余":"")+'<em class="orange">'+r.toFixed(2)+"<\/em>元")})});n.parent().on("click",function(){n.attr("sel")==1?h(0):h(1)});var y=function(){h(n.attr("sel"))},d=function(n){if(n.result==404){comfirmTips("请登录后操作,是否马上登录?",function(){goLogin()});return}$.PageDialog.ok(n.desc,function(){location="../../../User.htm"/*tpa=http://m.yygou.cn/User*/})},g=function(){i.removeClass("grayBtn").on("click",c)},nt=function(n,t,r){if(i.addClass("grayBtn").unbind("click"),t>0){var u=payBuyRecharge(r,t,"01");if(u.result)i.text("正在启动支付..");else{i.removeClass("grayBtn").on("click",c);$.PageDialog.fail(u.desc)}}else sendJsonp("/Order/PayOrder",{oamount:n,ramount:t,bank:r},d,null,g)},c=function(){nt(o,r,t)};i.on("click",c);p=parseFloat($("[data-userinfo='cartamount']").html());isNaN(p)?getCartNum(s):s()})